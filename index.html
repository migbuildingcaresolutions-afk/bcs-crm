<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Building Care Solutions - CRM</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        header { background: #333; color: #fff; padding: 15px; text-align: center; font-size: 24px; }
        nav { display: flex; justify-content: center; background: #444; }
        nav button { padding: 10px 20px; margin: 0 5px; border: none; background: #555; color: #fff; cursor: pointer; }
        nav button.active { background: #ff6600; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 8px; text-align: left; }
        button { cursor: pointer; }
        input, select { padding: 5px; margin: 2px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: #fff; margin: 10% auto; padding: 20px; width: 50%; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 18px; }
        .line-item { display: flex; gap: 5px; margin-bottom: 5px; }
        .totals { font-weight: bold; margin-top: 10px; }
        .trade-section { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>
    <header>Building Care Solutions - CRM</header>
    <nav>
        <button class="nav-tab active" onclick="showTab('customers')">Customers</button>
        <button class="nav-tab" onclick="showTab('estimates')">Estimates</button>
        <button class="nav-tab" onclick="showTab('quotes')">Quotes</button>
        <button class="nav-tab" onclick="showTab('invoices')">Invoices</button>
        <button class="nav-tab" onclick="showTab('workorders')">Work Orders</button>
    </nav>

    <!-- Customers Tab -->
    <div id="customers" class="tab-content active">
        <button onclick="showAddCustomerModal()">Add Customer</button>
        <input type="text" placeholder="Search Customer" oninput="searchCustomers(this.value)">
        <table id="customersTable">
            <thead>
                <tr><th>Name</th><th>Phone</th><th>Email</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Estimates Tab -->
    <div id="estimates" class="tab-content">
        <h3>Create Estimate</h3>
        <label>Customer: <select id="estimateCustomer"></select></label>
        <div>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="painting"> Painting</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="drywall"> Drywall</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="carpentry"> Carpentry</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="plumbing"> Plumbing</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="electrical"> Electrical</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="stucco"> Stucco</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="windows"> Windows/Doors</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="cabinets"> Cabinets</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="insulation"> Insulation</label>
            <label><input type="checkbox" onchange="toggleTradeSection(this)" data-trade="water"> Water Remediation</label>
        </div>
        <div id="tradeSections"></div>
        <button onclick="updateEstimate()">Calculate Estimate</button>
        <div id="estimateBreakdown"></div>
        <button onclick="convertToQuote()">Convert to Quote</button>
    </div>

    <!-- Quotes Tab -->
    <div id="quotes" class="tab-content">
        <h3>Quotes</h3>
        <table id="quotesTable">
            <thead>
                <tr><th>Quote #</th><th>Customer</th><th>Total</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Invoices Tab -->
    <div id="invoices" class="tab-content">
        <h3>Invoices</h3>
        <table id="invoicesTable">
            <thead>
                <tr><th>Invoice #</th><th>Customer</th><th>Total</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Work Orders Tab -->
    <div id="workorders" class="tab-content">
        <h3>Work Orders</h3>
        <table id="workOrdersTable">
            <thead>
                <tr><th>WO #</th><th>Customer</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="customerModalTitle">Add Customer</h3>
            <form id="customerForm">
                <label>Name: <input type="text" id="customerName" required></label><br>
                <label>Phone: <input type="text" id="customerPhone"></label><br>
                <label>Email: <input type="email" id="customerEmail"></label><br>
                <button type="submit">Save Customer</button>
            </form>
        </div>
    </div>

    <script>
        // ======== Data Storage ========
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let quotes = JSON.parse(localStorage.getItem('quotes')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let workOrders = JSON.parse(localStorage.getItem('workOrders')) || [];
        let nextInvoiceNumber = parseInt(localStorage.getItem('nextInvoiceNumber')) || 1001;
        let nextQuoteNumber = parseInt(localStorage.getItem('nextQuoteNumber')) || 2001;
        let nextWorkOrderNumber = parseInt(localStorage.getItem('nextWorkOrderNumber')) || 3001;
        const TAX_RATE = 0.0775;
        const LABOR_RATE = 75;

        const pricingData = {
            painting: { min: 100, max: 500 },
            drywall: { min: 200, max: 1000 },
            carpentry: { min: 150, max: 800 },
            plumbing: { min: 150, max: 800 },
            electrical: { min: 150, max: 800 },
            stucco: { min: 200, max: 1000 },
            windows: { min: 200, max: 1200 },
            cabinets: { min: 200, max: 1500 },
            insulation: { min: 100, max: 700 },
            water: { min: 500, max: 5000 }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadCustomers();
            populateCustomerDropdowns();
            loadQuotes();
            loadInvoices();
            loadWorkOrders();
        });

        // ======== Tabs ========
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(nt => nt.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // ======== Customer Functions ========
        function showAddCustomerModal() {
            document.getElementById('customerModalTitle').innerText = 'Add Customer';
            document.getElementById('customerForm').dataset.mode = 'add';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        document.getElementById('customerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const mode = e.target.dataset.mode;
            if (mode === 'add') {
                customers.push({ id: Date.now(), name, phone, email });
            } else if (mode === 'edit') {
                const id = parseInt(e.target.dataset.id);
                const customer = customers.find(c => c.id === id);
                if (customer) { customer.name = name; customer.phone = phone; customer.email = email; }
            }
            localStorage.setItem('customers', JSON.stringify(customers));
            loadCustomers();
            populateCustomerDropdowns();
            closeModal();
        });

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            document.getElementById('customerModalTitle').innerText = 'Edit Customer';
            document.getElementById('customerForm').dataset.mode = 'edit';
            document.getElementById('customerForm').dataset.id = id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerModal').style.display = 'block';
        }

        function deleteCustomer(id) {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            customers = customers.filter(c => c.id !== id);
            localStorage.setItem('customers', JSON.stringify(customers));
            loadCustomers();
            populateCustomerDropdowns();
        }

        function loadCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';
            customers.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.name}</td><td>${c.phone}</td><td>${c.email}</td>
                    <td>
                        <button onclick="editCustomer(${c.id})">Edit</button>
                        <button onclick="deleteCustomer(${c.id})">Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function searchCustomers(query) {
            const rows = document.querySelectorAll('#customersTable tbody tr');
            rows.forEach(r => {
                r.style.display = r.cells[0].innerText.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function populateCustomerDropdowns() {
            const selectIds = ['estimateCustomer'];
            selectIds.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                sel.innerHTML = '<option value="">--Select Customer--</option>';
                customers.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.text = c.name;
                    sel.appendChild(opt);
                });
            });
        }

        // ======== Estimate / Quote / Invoice Functions ========
        function toggleTradeSection(checkbox) {
            const trade = checkbox.dataset.trade;
            const existing = document.getElementById(`trade-${trade}`);
            if (checkbox.checked) {
                if (!existing) {
                    const div = document.createElement('div');
                    div.className = 'trade-section';
                    div.id = `trade-${trade}`;
                    div.style.display = 'block';
                    div.innerHTML = `<h4>${trade.charAt(0).toUpperCase()+trade.slice(1)}</h4>
                    <label>Qty: <input type="number" min="1" value="1" class="trade-qty"></label>
                    <label>Rate: <input type="number" min="0" value="${pricingData[trade].min}" class="trade-rate"></label>`;
                    document.getElementById('tradeSections').appendChild(div);
                } else existing.style.display = 'block';
            } else if (existing) existing.style.display = 'none';
        }

        function updateEstimate() {
            const customerId = document.getElementById('estimateCustomer').value;
            if (!customerId) { alert('Please select a customer'); return; }
            const selectedTrades = document.querySelectorAll('.trade-section');
            if (selectedTrades.length === 0) { alert('Select at least one trade'); return; }
            let total = 0;
            selectedTrades.forEach(sec => {
                if (sec.style.display === 'none') return;
                const qty = parseFloat(sec.querySelector('.trade-qty').value) || 1;
                const rate = parseFloat(sec.querySelector('.trade-rate').value) || 0;
                total += qty*rate;
            });
            document.getElementById('estimateBreakdown').innerText = `Total Estimate: $${total.toFixed(2)}`;
            return total;
        }

        function convertToQuote() {
            const total = updateEstimate();
            if (!total) return;
            const customerId = document.getElementById('estimateCustomer').value;
            const customer = customers.find(c => c.id == customerId);
            if (!customer) { alert('Invalid customer'); return; }
            const quote = { id: nextQuoteNumber++, customerId: customer.id, customerName: customer.name, total };
            quotes.push(quote);
            localStorage.setItem('quotes', JSON.stringify(quotes));
            localStorage.setItem('nextQuoteNumber', nextQuoteNumber);
            loadQuotes();
            showTab('quotes');
        }

        function loadQuotes() {
            const tbody = document.querySelector('#quotesTable tbody');
            tbody.innerHTML = '';
            quotes.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${q.id}</td><td>${q.customerName}</td><td>$${q.total.toFixed(2)}</td>
                    <td><button onclick="generateQuotePreview(${q.id})">Preview</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function loadInvoices() {
            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';
            invoices.forEach(inv => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${inv.id}</td><td>${inv.customerName}</td><td>$${inv.total.toFixed(2)}</td>
                    <td><button onclick="generateInvoicePreview(${inv.id})">Preview</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function loadWorkOrders() {
            const tbody = document.querySelector('#workOrdersTable tbody');
            tbody.innerHTML = '';
            workOrders.forEach(wo => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${wo.id}</td><td>${wo.customerName}</td><td>${wo.status}</td>
                    <td><button onclick="viewWorkOrder(${wo.id})">View</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function generateInvoicePreview(id) {
            const inv = invoices.find(i=>i.id===id);
            if(!inv) return;
            alert(`Invoice #${inv.id} for ${inv.customerName}\nTotal: $${inv.total.toFixed(2)}`);
        }

        function generateQuotePreview(id) {
            const q = quotes.find(i=>i.id===id);
            if(!q) return;
            alert(`Quote #${q.id} for ${q.customerName}\nTotal: $${q.total.toFixed(2)}`);
        }

        function viewWorkOrder(id) {
            const wo = workOrders.find(i=>i.id===id);
            if(!wo) return;
            alert(`Work Order #${wo.id} for ${wo.customerName}\nStatus: ${wo.status}`);
        }
    </script>
</body>
</html>
